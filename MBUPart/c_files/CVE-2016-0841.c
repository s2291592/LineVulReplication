const sp<IMediaPlayerService>& MediaMetadataRetriever::getService()
 {
     Mutex::Autolock lock(sServiceLock);
     if (sService == 0) {
        sp<IServiceManager> sm = defaultServiceManager();
        sp<IBinder> binder;
 do {
            binder = sm->getService(String16("media.player"));
 if (binder != 0) {
 break;
 }
            ALOGW("MediaPlayerService not published, waiting...");
            usleep(500000); // 0.5 s
 } while (true);
 if (sDeathNotifier == NULL) {
            sDeathNotifier = new DeathNotifier();
 }
        binder->linkToDeath(sDeathNotifier);
        sService = interface_cast<IMediaPlayerService>(binder);
 }
    ALOGE_IF(sService == 0, "no MediaPlayerService!?");
 return sService;
}

void MediaMetadataRetriever::DeathNotifier::binderDied(const wp<IBinder>& who __unused) {
 Mutex::Autolock lock(MediaMetadataRetriever::sServiceLock);
 MediaMetadataRetriever::sService.clear();
    ALOGW("MediaMetadataRetriever server died!");
}

sp<IMemory> MediaMetadataRetriever::extractAlbumArt()
{
    ALOGV("extractAlbumArt");
 Mutex::Autolock _l(mLock);
 if (mRetriever == 0) {
        ALOGE("retriever is not initialized");
 return NULL;
 }
 return mRetriever->extractAlbumArt();
}

sp<IMemory> MediaMetadataRetriever::getFrameAtTime(int64_t timeUs, int option)
{
    ALOGV("getFrameAtTime: time(%" PRId64 " us) option(%d)", timeUs, option);
 Mutex::Autolock _l(mLock);
 if (mRetriever == 0) {
        ALOGE("retriever is not initialized");
 return NULL;
 }
 return mRetriever->getFrameAtTime(timeUs, option);
}

MediaMetadataRetriever::MediaMetadataRetriever()
{
ALOGV("constructor");
    const sp<IMediaPlayerService>& service(getService());
if (service == 0) {
ALOGE("failed to obtain MediaMetadataRetrieverService");
return;
}
sp<IMediaMetadataRetriever> retriever(service->createMetadataRetriever());
if (retriever == 0) {
ALOGE("failed to create IMediaMetadataRetriever object from server");
}
mRetriever = retriever;
}

MediaMetadataRetriever::DeathNotifier::~DeathNotifier()
{
 Mutex::Autolock lock(sServiceLock);
 if (sService != 0) {
        sService->asBinder()->unlinkToDeath(this);
 }
}

void MediaMetadataRetriever::disconnect()
{
    ALOGV("disconnect");
    sp<IMediaMetadataRetriever> retriever;
 {
 Mutex::Autolock _l(mLock);
        retriever = mRetriever;
        mRetriever.clear();
 }
 if (retriever != 0) {
        retriever->disconnect();
 }
}

status_t MediaMetadataRetriever::setDataSource(int fd, int64_t offset, int64_t length)
{
    ALOGV("setDataSource(%d, %" PRId64 ", %" PRId64 ")", fd, offset, length);
 Mutex::Autolock _l(mLock);
 if (mRetriever == 0) {
        ALOGE("retriever is not initialized");
 return INVALID_OPERATION;
 }
 if (fd < 0 || offset < 0 || length < 0) {
        ALOGE("Invalid negative argument");
 return UNKNOWN_ERROR;
 }
 return mRetriever->setDataSource(fd, offset, length);
}

MediaMetadataRetriever::~MediaMetadataRetriever()
{
    ALOGV("destructor");
    disconnect();
 IPCThreadState::self()->flushCommands();
}

const char* MediaMetadataRetriever::extractMetadata(int keyCode)
{
    ALOGV("extractMetadata(%d)", keyCode);
 Mutex::Autolock _l(mLock);
 if (mRetriever == 0) {
        ALOGE("retriever is not initialized");
 return NULL;
 }
 return mRetriever->extractMetadata(keyCode);
}
