void KioskNextHomeInterfaceBrokerImpl::GetAppController(
mojom::AppControllerRequest request) {
  app_controller_->BindRequest(std::move(request));
}

const std::string& AppControllerImpl::MaybeGetAndroidPackageName(
     const std::string& app_id) {
   const auto& package_name_it = android_package_map_.find(app_id);
  if (package_name_it != android_package_map_.end()) {
    return package_name_it->second;
  }

  ArcAppListPrefs* arc_prefs_ = ArcAppListPrefs::Get(profile_);
  if (!arc_prefs_) {
    return base::EmptyString();
  }
  std::unique_ptr<ArcAppListPrefs::AppInfo> arc_info =
      arc_prefs_->GetApp(app_id);
  if (!arc_info) {
    return base::EmptyString();
  }

  android_package_map_[app_id] = arc_info->package_name;
  return android_package_map_[app_id];
}

void AppControllerImpl::LaunchHomeUrl(const std::string& suffix,
                                      LaunchHomeUrlCallback callback) {
if (url_prefix_.empty()) {
std::move(callback).Run(false, "No URL prefix.");
return;
}

GURL url(url_prefix_ + suffix);
if (!url.is_valid()) {
std::move(callback).Run(false, "Invalid URL.");
return;
}

arc::mojom::AppInstance* app_instance =
arc::ArcServiceManager::Get()
? ARC_GET_INSTANCE_FOR_METHOD(
arc::ArcServiceManager::Get()->arc_bridge_service()->app(),
LaunchIntent)
: nullptr;

if (!app_instance) {
std::move(callback).Run(false, "ARC bridge not available.");
return;
}

app_instance->LaunchIntent(url.spec(), display::kDefaultDisplayId);
std::move(callback).Run(true, base::nullopt);
}

mojom::AppPtr AppControllerImpl::CreateAppPtr(const apps::AppUpdate& update) {
   auto app = chromeos::kiosk_next_home::mojom::App::New();
   app->app_id = update.AppId();
   app->type = update.AppType();
  app->display_name = update.Name();
  app->readiness = update.Readiness();

  if (app->type == apps::mojom::AppType::kArc) {
    app->android_package_name = MaybeGetAndroidPackageName(app->app_id);
  }
   return app;
 }

void AppControllerImpl::GetApps(
     mojom::AppController::GetAppsCallback callback) {
   std::vector<chromeos::kiosk_next_home::mojom::AppPtr> app_list;
  app_service_proxy_->AppRegistryCache().ForEachApp(
      [this, &app_list](const apps::AppUpdate& update) {
        app_list.push_back(CreateAppPtr(update));
      });
   std::move(callback).Run(std::move(app_list));
 }

KioskNextHomeInterfaceBrokerImpl::KioskNextHomeInterfaceBrokerImpl(
content::BrowserContext* context)
    : connector_(content::BrowserContext::GetConnectorFor(context)->Clone()),
      app_controller_(std::make_unique<AppControllerImpl>(
          Profile::FromBrowserContext(context))) {}

 void KioskNextHomeInterfaceBrokerImpl::BindRequest(
    mojom::KioskNextHomeInterfaceBrokerRequest request) {
  bindings_.AddBinding(this, std::move(request));
}

void AppControllerImpl::OnAppUpdate(const apps::AppUpdate& update) {
   if (!update.StateIsNull() && !update.NameChanged() &&
       !update.ReadinessChanged()) {
    return;
  }

  if (client_) {
    client_->OnAppChanged(CreateAppPtr(update));
   }
 }

void AppControllerImpl::SetClient(mojom::AppControllerClientPtr client) {
   client_ = std::move(client);
 }

AppControllerImpl::~AppControllerImpl() {
  // We can outlive the AppServiceProxy during Profile destruction, so we need
  // to test if the proxy still exists before removing the observer.
  if (apps::AppServiceProxy::Get(profile_))
    app_service_proxy_->AppRegistryCache().RemoveObserver(this);
}

AppControllerImpl::AppControllerImpl(Profile* profile)
: profile_(profile),
app_service_proxy_(apps::AppServiceProxy::Get(profile)),
url_prefix_(base::CommandLine::ForCurrentProcess()->GetSwitchValueASCII(
chromeos::switches::kKioskNextHomeUrlPrefix)) {
app_service_proxy_->AppRegistryCache().AddObserver(this);

// Add the chrome://app-icon URL data source.
// TODO(ltenorio): Move this to a more suitable location when we change
// the Kiosk Next Home to WebUI.
  if (profile) {
    content::URLDataSource::Add(profile,
                                std::make_unique<apps::AppIconSource>(profile));
  }
}

void AppControllerImpl::GetArcAndroidId(
     mojom::AppController::GetArcAndroidIdCallback callback) {
   arc::GetAndroidId(base::BindOnce(
       [](mojom::AppController::GetArcAndroidIdCallback callback, bool success,
         int64_t android_id) {
        std::move(callback).Run(success, base::NumberToString(android_id));
      },
       std::move(callback)));
 }
