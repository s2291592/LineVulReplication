QuotaTaskObserver::QuotaTaskObserver() {
}

void QuotaThreadTask::CallRunOnTargetThread() {
  DCHECK(target_task_runner_->RunsTasksOnCurrentThread());
  if (RunOnTargetThreadAsync())
    original_task_runner()->PostTask(
        FROM_HERE,
        base::Bind(&QuotaThreadTask::CallCompleted, this));
}

QuotaTask::~QuotaTask() {
}

QuotaTaskObserver::~QuotaTaskObserver() {
  std::for_each(running_quota_tasks_.begin(),
                running_quota_tasks_.end(),
                std::mem_fun(&QuotaTask::Abort));
}

 void QuotaTask::CallCompleted() {
  DCHECK(original_task_runner_->BelongsToCurrentThread());
  if (observer_) {
    observer_->UnregisterTask(this);
    Completed();
  }
}

QuotaThreadTask::~QuotaThreadTask() {
}

void QuotaThreadTask::Run() {
  target_task_runner_->PostTask(
      FROM_HERE,
      base::Bind(&QuotaThreadTask::CallRunOnTargetThread, this));
}

 void QuotaTask::DeleteSoon() {
   MessageLoop::current()->DeleteSoon(FROM_HERE, this);
 }

QuotaTask::QuotaTask(QuotaTaskObserver* observer)
: observer_(observer),
      original_task_runner_(base::MessageLoopProxy::current()) {
}

bool QuotaThreadTask::RunOnTargetThreadAsync() {
  RunOnTargetThread();
  return true;
}

void QuotaThreadTask::RunOnTargetThread() {
}

void QuotaTaskObserver::UnregisterTask(QuotaTask* task) {
  DCHECK(running_quota_tasks_.find(task) != running_quota_tasks_.end());
  running_quota_tasks_.erase(task);
}

void QuotaTask::Abort() {
  DCHECK(original_task_runner_->BelongsToCurrentThread());
  observer_ = NULL;
  Aborted();
 }

void QuotaTaskObserver::RegisterTask(QuotaTask* task) {
  running_quota_tasks_.insert(task);
}
